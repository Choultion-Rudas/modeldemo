<!DOCTYPE html>
<html lang="zh-CN">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>SenseVoice-Small</title>
	<link rel="preconnect" href="https://fonts.googleapis.com">
	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link href="https://fonts.googleapis.com/css2?family=Google+Sans+Text:wght@400;500;700&display=swap"
		rel="stylesheet">
	<link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
	<script type="module" src="https://unpkg.com/@material/web/all.js?module"></script>
	<style>
		:root {
			color-scheme: light;
			--md-sys-color-primary: #0b57d0;
			--md-sys-color-on-primary: #ffffff;
			--md-sys-color-primary-container: #d8e2ff;
			--md-sys-color-on-primary-container: #001947;
			--md-sys-color-secondary: #585e71;
			--md-sys-color-on-secondary: #ffffff;
			--md-sys-color-secondary-container: #dce2f9;
			--md-sys-color-on-secondary-container: #151b2c;
			--md-sys-color-tertiary: #735471;
			--md-sys-color-on-tertiary: #ffffff;
			--md-sys-color-tertiary-container: #fed7f9;
			--md-sys-color-on-tertiary-container: #2b122b;
			--md-sys-color-error: #ba1a1a;
			--md-sys-color-on-error: #ffffff;
			--md-sys-color-error-container: #ffdad6;
			--md-sys-color-on-error-container: #410002;
			--md-sys-color-background: #fdfbff;
			--md-sys-color-on-background: #1b1b1f;
			--md-sys-color-surface: #fdfbff;
			--md-sys-color-on-surface: #1b1b1f;
			--md-sys-color-surface-variant: #e1e2ec;
			--md-sys-color-on-surface-variant: #44474f;
			--md-sys-color-outline: #75777f;
			--md-sys-color-inverse-on-surface: #f2f0f4;
			--md-sys-color-inverse-surface: #2f3033;
			--md-sys-color-inverse-primary: #a8c7fa;
			--md-sys-color-shadow: #000000;
			--md-sys-color-surface-tint: #0b57d0;
			--md-sys-color-outline-variant: #c5c6d0;
			--md-sys-color-scrim: #000000;
			--md-sys-color-surface-container-highest: #e3e2e6;
			--md-sys-color-surface-container-high: #eae7eb;
			--md-sys-color-surface-container: #efedf1;
			--md-sys-color-surface-container-low: #f5f3f7;
			--md-sys-color-surface-container-lowest: #ffffff
		}

		@media (prefers-color-scheme: dark) {
			:root {
				color-scheme: dark;
				--md-sys-color-primary: #a8c7fa;
				--md-sys-color-on-primary: #002d68;
				--md-sys-color-primary-container: #00428f;
				--md-sys-color-on-primary-container: #d8e2ff;
				--md-sys-color-secondary: #c0c6dd;
				--md-sys-color-on-secondary: #2a3042;
				--md-sys-color-secondary-container: #404659;
				--md-sys-color-on-secondary-container: #dce2f9;
				--md-sys-color-tertiary: #e0bbda;
				--md-sys-color-on-tertiary: #422741;
				--md-sys-color-tertiary-container: #5a3d58;
				--md-sys-color-on-tertiary-container: #fed7f9;
				--md-sys-color-error: #ffb4ab;
				--md-sys-color-on-error: #690005;
				--md-sys-color-error-container: #93000a;
				--md-sys-color-on-error-container: #ffdad6;
				--md-sys-color-background: #1b1b1f;
				--md-sys-color-on-background: #e3e2e6;
				--md-sys-color-surface: #121418;
				--md-sys-color-on-surface: #e3e2e6;
				--md-sys-color-surface-variant: #44474f;
				--md-sys-color-on-surface-variant: #c5c6d0;
				--md-sys-color-outline: #8e9199;
				--md-sys-color-inverse-on-surface: #1b1b1f;
				--md-sys-color-inverse-surface: #e3e2e6;
				--md-sys-color-inverse-primary: #0b57d0;
				--md-sys-color-shadow: #000000;
				--md-sys-color-surface-tint: #a8c7fa;
				--md-sys-color-outline-variant: #44474f;
				--md-sys-color-scrim: #000000;
				--md-sys-color-surface-container-highest: #353539;
				--md-sys-color-surface-container-high: #2a2a2e;
				--md-sys-color-surface-container: #1f2023;
				--md-sys-color-surface-container-low: #1b1b1f;
				--md-sys-color-surface-container-lowest: #0d0f13
			}
		}

		body {
			font-family: 'Google Sans Text', sans-serif;
			background-color: var(--md-sys-color-surface);
			color: var(--md-sys-color-on-surface);
			display: flex;
			justify-content: center;
			align-items: flex-start;
			padding: 1.5rem;
			min-height: 100vh;
			box-sizing: border-box;
			transition: background-color .3s ease
		}

		.card {
			max-width: 700px;
			width: 100%;
			background-color: var(--md-sys-color-surface);
			border-radius: 16px;
			padding: 24px;
			transition: background-color .3s ease, outline .2s ease
		}

		.card.drag-over {
			outline: 2px dashed var(--md-sys-color-primary);
			outline-offset: -8px
		}

		.header {
			text-align: center;
			margin-bottom: 24px
		}

		.header h1 {
			color: var(--md-sys-color-primary);
			font-size: 28px;
			font-weight: 700;
			margin: 0 0 12px 0
		}

		.header p {
			margin: 4px 0;
			color: var(--md-sys-color-on-surface-variant)
		}

		.header .subtitle {
			font-size: .8rem;
			color: var(--md-sys-color-outline)
		}

		.form-group,
		.checkbox-group {
			margin-bottom: 20px
		}

		.checkbox-group {
			display: flex;
			align-items: center;
			cursor: pointer;
			color: var(--md-sys-color-on-surface-variant)
		}

		md-checkbox {
			margin-right: 8px
		}

		.file-upload-wrapper {
			display: flex;
			flex-direction: column;
			align-items: flex-start;
			gap: 8px
		}

		.file-controls {
			display: flex;
			align-items: center;
			gap: 16px
		}

		.drop-hint {
			display: none;
			font-size: .8rem;
			color: var(--md-sys-color-outline);
			margin: 0
		}

		@media (pointer:fine) {
			.drop-hint {
				display: block
			}
		}

		.slider-group label {
			color: var(--md-sys-color-on-surface-variant);
			font-size: .9rem;
			margin-bottom: 8px
		}

		.button-wrapper {
			display: flex;
			justify-content: flex-end;
			align-items: center;
			gap: 16px;
			margin-top: 24px
		}

		.result-wrapper {
			margin-top: 24px
		}

		.result-header {
			display: flex;
			justify-content: space-between;
			align-items: center;
			margin-bottom: 8px
		}

		.result-header label {
			font-weight: 500;
			color: var(--md-sys-color-on-surface-variant)
		}

		#audio_input {
			display: none
		}

		md-filled-select,
		md-outlined-text-field {
			width: 100%
		}

		md-outlined-text-field {
			--md-outlined-text-field-container-shape: 8px
		}

		details {
			border-top: 1px solid var(--md-sys-color-outline);
			margin-top: 24px;
			padding-top: 20px
		}

		details>summary {
			cursor: pointer;
			font-weight: 500;
			font-size: 1rem;
			color: var(--md-sys-color-primary);
			list-style: none
		}

		details>summary::-webkit-details-marker {
			display: none
		}

		.details-content-wrapper {
			display: grid;
			grid-template-rows: 0fr;
			transition: grid-template-rows .3s ease-in-out
		}

		details[open]>.details-content-wrapper {
			grid-template-rows: 1fr
		}

		.advanced-settings-content {
			padding-top: 20px;
			overflow: hidden
		}
	</style>
</head>

<body>
	<div class="card" id="drop-zone">
		<div class="header">
			<h1>SenseVoice-Small 语音识别</h1>
			<p>SenseVoice 是具有音频理解能力的音频基础模型，包括语音识别（ASR）、语种识别（LID）、语音情感识别（SER）和声学事件分类（AEC）或声学事件检测（AED）。</p>
			<p class="subtitle">支持 MP3, WAV, FLAC, M4A 等常见音频格式。</p>
		</div>
		<div class="form-group file-upload-wrapper">
			<div class="file-controls">
				<md-filled-button id="upload-button"><span class="material-icons"
						slot="icon">upload_file</span>上传音频</md-filled-button>
				<span id="file-name-label">尚未选择文件</span>
			</div>
			<p class="drop-hint">或拖拽文件至此区域</p>
			<input type="file" id="audio_input" accept="audio/*">
		</div>
		<div class="form-group">
			<md-filled-select id="language" label="源语言">
				<md-select-option value="auto" selected>
					<div slot="headline">自动检测</div>
				</md-select-option>
				<md-select-option value="zh">
					<div slot="headline">中文</div>
				</md-select-option>
				<md-select-option value="en">
					<div slot="headline">English</div>
				</md-select-option>
				<md-select-option value="yue">
					<div slot="headline">粤语</div>
				</md-select-option>
				<md-select-option value="ja">
					<div slot="headline">日本語</div>
				</md-select-option>
				<md-select-option value="ko">
					<div slot="headline">한국어</div>
				</md-select-option>
				<md-select-option value="nospeech">
					<div slot="headline">无语音</div>
				</md-select-option>
			</md-filled-select>
		</div>
		<div class="form-group">
			<md-filled-select id="output_format" label="输出格式">
				<md-select-option value="纯净文本" selected>
					<div slot="headline">纯净文本</div>
				</md-select-option>
				<md-select-option value="原始富文本">
					<div slot="headline">原始富文本</div>
				</md-select-option>
				<md-select-option value="Emoji 格式">
					<div slot="headline">Emoji 格式</div>
				</md-select-option>
			</md-filled-select>
		</div>
		<details>
			<summary>高级设置</summary>
			<div class="details-content-wrapper">
				<div class="advanced-settings-content">
					<div class="form-group slider-group">
						<label id="slider-label">断句最大长度（秒）：15s</label>
						<md-slider id="merge_length" min="5" max="30" value="15" step="1" labeled></md-slider>
					</div>
					<label class="checkbox-group" for="use_itn"><md-checkbox id="use_itn"
							checked></md-checkbox>自动添加标点与格式化</label>
					<label class="checkbox-group" for="merge_vad"><md-checkbox id="merge_vad"
							checked></md-checkbox>优化长音频断句</label>
					<label class="checkbox-group" for="ban_emo_unk"><md-checkbox
							id="ban_emo_unk"></md-checkbox>强制情感分类</label>
				</div>
			</div>
		</details>
		<div class="button-wrapper">
			<p id="status-text"></p>
			<md-circular-progress indeterminate style="display: none;" id="loader"></md-circular-progress>
			<md-filled-button id="submit-button">开始识别</md-filled-button>
		</div>
		<div class="result-wrapper" id="result-wrapper" style="display: none;">
			<div class="result-header">
				<label>识别结果</label>
				<md-icon-button id="copy-button"><span id="copy-icon" class="material-icons"
						slot="icon">content_copy</span></md-icon-button>
			</div>
			<md-outlined-text-field id="result-text" type="textarea" rows="8" readonly></md-outlined-text-field>
		</div>
	</div>
	<script type="module">
		document.addEventListener('DOMContentLoaded', () => {
			const dropZone = document.getElementById('drop-zone');
			const uploadButton = document.getElementById('upload-button');
			const audioInput = document.getElementById('audio_input');
			const fileNameLabel = document.getElementById('file-name-label');
			const submitButton = document.getElementById('submit-button');
			const statusText = document.getElementById('status-text');
			const loader = document.getElementById('loader');
			const resultWrapper = document.getElementById('result-wrapper');
			const resultText = document.getElementById('result-text');
			const copyButton = document.getElementById('copy-button');
			const copyIcon = document.getElementById('copy-icon');
			const mergeLengthSlider = document.getElementById('merge_length');
			const sliderLabel = document.getElementById('slider-label');

			uploadButton.addEventListener('click', () => audioInput.click());
			audioInput.addEventListener('change', () => { if (audioInput.files.length > 0) fileNameLabel.textContent = audioInput.files[0].name; });
			mergeLengthSlider.addEventListener('input', () => { sliderLabel.textContent = `断句最大长度（秒）：${mergeLengthSlider.value}s`; });
			['dragenter', 'dragover', 'dragleave', 'drop'].forEach(n => dropZone.addEventListener(n, e => { e.preventDefault(); e.stopPropagation(); }, false));
			['dragenter', 'dragover'].forEach(n => dropZone.addEventListener(n, () => dropZone.classList.add('drag-over'), false));
			['dragleave', 'drop'].forEach(n => dropZone.addEventListener(n, () => dropZone.classList.remove('drag-over'), false));
			dropZone.addEventListener('drop', e => { const files = e.dataTransfer.files; if (files.length > 0) { audioInput.files = files; fileNameLabel.textContent = files[0].name; } }, false);
			copyButton.addEventListener('click', () => { navigator.clipboard.writeText(resultText.value || '').then(() => { copyIcon.textContent = 'check'; setTimeout(() => { copyIcon.textContent = 'content_copy'; }, 1000); }); });

			const API_BASE = '/api';
			let cachedFnIndex = null;
			async function getFnIndex() {
				if (cachedFnIndex !== null) return cachedFnIndex;
				let resp = await fetch(`${API_BASE}/gradio_api/config`);
				if (!resp.ok) resp = await fetch(`${API_BASE}/config`);
				const cfg = await resp.json().catch(() => ({}));
				let idx = 0;
				if (cfg && cfg.named_endpoints && (cfg.named_endpoints['/model_inference'] !== undefined)) {
					idx = cfg.named_endpoints['/model_inference'];
				} else if (cfg && cfg.dependencies) {
					for (let i = 0; i < cfg.dependencies.length; i++) {
						const d = cfg.dependencies[i];
						if (d && (d.api_name === '/model_inference' || d.api_name === 'model_inference')) { idx = i; break; }
					}
				}
				cachedFnIndex = idx;
				return idx;
			}
			function genHash() { return Math.random().toString(36).slice(2); }
			function readAsDataURL(file) {
				return new Promise((resolve, reject) => {
					const r = new FileReader();
					r.onload = () => resolve(r.result);
					r.onerror = reject;
					r.readAsDataURL(file);
				});
			}
			async function runViaQueue(firstArg, fnIndex, sessionHash, onStatus) {
				const join = await fetch(`${API_BASE}/gradio_api/queue/join`, {
					method: 'POST',
					headers: { 'Content-Type': 'application/json' },
					body: JSON.stringify({
						data: [
							firstArg,
							document.getElementById('language').value,
							document.getElementById('output_format').value,
							document.getElementById('use_itn').checked,
							document.getElementById('merge_vad').checked,
							parseFloat(document.getElementById('merge_length').value),
							document.getElementById('ban_emo_unk').checked
						],
						fn_index: fnIndex,
						session_hash: sessionHash
					})
				});
				if (!join.ok) { const t = await join.text(); throw new Error(`加入队列失败: ${join.status} ${t}`); }
				return await new Promise((resolve, reject) => {
					const es = new EventSource(`${API_BASE}/gradio_api/queue/data?session_hash=${sessionHash}`);
					let finished = false;
					const timeout = setTimeout(() => { if (!finished) { finished = true; es.close(); reject(new Error('处理超时')); } }, 15 * 60 * 1000);
					es.onmessage = (e) => {
						try {
							const data = JSON.parse(e.data);
							if (data.msg === 'estimation' && data.rank !== undefined) {
								if (onStatus) onStatus(`排队中，前方还有 ${data.rank} 个任务...`);
							} else if (data.msg === 'process_starts') {
								if (onStatus) onStatus('开始处理...');
							} else if (data.msg === 'process_completed') {
								const ok = data.success === true;
								const out = data.output || {};
								const text = out && out.data && Array.isArray(out.data) ? (out.data[0] ?? '') : '';
								if (!finished) { finished = true; clearTimeout(timeout); es.close(); ok ? resolve(text) : reject(new Error('服务器返回错误')); }
							} else if (data.msg === 'queue_full') {
								if (!finished) { finished = true; clearTimeout(timeout); es.close(); reject(new Error('队列已满，请稍后再试')); }
							}
						} catch (_) { }
					};
					es.onerror = () => {
						if (!finished) { finished = true; clearTimeout(timeout); es.close(); reject(new Error('队列连接中断')); }
					};
				});
			}

			submitButton.addEventListener('click', async () => {
				if (audioInput.files.length === 0) { statusText.textContent = '错误：请上传或录制音频。'; return; }
				submitButton.disabled = true;
				loader.style.display = 'block';
				statusText.textContent = '准备上传...';
				resultWrapper.style.display = 'none';

				const file = audioInput.files[0];
				const fnIndex = await getFnIndex();
				const sessionHash = genHash();

				try {
					const form = new FormData();
					form.append('files', file);
					const up = await fetch(`${API_BASE}/gradio_api/upload?upload_id=${sessionHash}`, { method: 'POST', body: form });
					if (!up.ok) { const t = await up.text(); throw new Error(`文件上传失败: ${up.status} ${t}`); }
					const arr = await up.json();
					const first = Array.isArray(arr) ? arr[0] : null;
					if (!first) throw new Error('上传响应中未找到文件信息');

					const pathStr = typeof first === 'string' ? first : first.path;
					if (!pathStr) throw new Error('上传结果格式异常');

					statusText.textContent = '已入队，排队/识别中...';
					let text = '';
					try {
						const fileObj = {
							path: pathStr,
							url: null,
							size: file.size,
							orig_name: file.name,
							mime_type: file.type || null,
							is_stream: false,
							meta: { _type: 'gradio.FileData' }
						};
						text = await runViaQueue(fileObj, fnIndex, sessionHash, (s) => statusText.textContent = s);
					} catch (e1) {
						statusText.textContent = '路径方式失败，尝试直接传文件...';
						const dataUrl = await readAsDataURL(file);
						const baseObj = { name: file.name, data: dataUrl, is_file: true };
						const sessionHash2 = genHash();
						text = await runViaQueue(baseObj, fnIndex, sessionHash2, (s) => statusText.textContent = s);
					}

					statusText.textContent = '识别完成！';
					resultText.value = text || '';
					resultWrapper.style.display = 'block';
				} catch (e) {
					statusText.textContent = `失败: ${e.message || e}`;
				} finally {
					submitButton.disabled = false;
					loader.style.display = 'none';
				}
			});
		});
	</script>
</body>

</html>